#!/bin/sh

# Dioxus Quarterly Planner pre-commit hook to mirror CI checks.

set -eu

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "â†’ Running cargo fmt -- --check"
cargo fmt -- --check

echo "â†’ Running cargo clippy -p planner-core"
cargo clippy -p planner-core -- -D warnings

echo "â†’ Running cargo clippy -p planner-app (web target)"
cargo clippy -p planner-app --target wasm32-unknown-unknown --features web -- -D warnings

echo "â†’ Running cargo clippy -p planner-app (desktop target)"
cargo clippy -p planner-app --features desktop --all-targets -- -D warnings

echo "â†’ Running cargo test -p planner-core --verbose"
cargo test -p planner-core --verbose

echo "â†’ Running cargo test -p planner-app --features desktop --verbose"
cargo test -p planner-app --features desktop --verbose

echo "â†’ Running cargo doc --no-deps"
cargo doc --no-deps

if ! command -v cargo-audit >/dev/null 2>&1; then
  cat <<'EOF' >&2
ðŸš« Missing required tooling: cargo-audit.
Install it once with:
  cargo install cargo-audit --locked
EOF
  exit 1
fi

echo "â†’ Running cargo audit"
cargo audit

if ! command -v dx >/dev/null 2>&1; then
  cat <<'EOF' >&2
ðŸš« Missing required tooling: dioxus-cli (dx).
Install it once with:
  cargo install dioxus-cli --locked
EOF
  exit 1
fi

echo "â†’ Running dx bundle -p planner-app --release (WASM build)"
dx bundle -p planner-app --release

echo "âœ“ All pre-commit checks passed"
